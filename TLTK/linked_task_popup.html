<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup Cấu hình Liên kết Task (P11-SUB)</title>
    <style>
        /* CSS Chung và Reset cơ bản */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
            padding: 20px;
        }
        
        /* Cấu trúc Modal/Popup */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Header (P11-N1) */
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background-color: #f7f7f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h4 {
            margin: 0;
            font-weight: 600;
        }

        /* Body */
        .modal-body {
            padding: 20px;
        }

        /* Group Thêm Quy tắc */
        .rule-creation-group {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
        }

        .rule-selection-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Input và Select */
        .rule-selection-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }
        
        /* Toggle Button (P11-S2) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 180px; /* Tăng chiều rộng tổng thể */
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #28a745; /* CÙNG TASK */
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "CÙNG TASK";
            height: 26px;
            width: 85px; /* Tăng chiều rộng của nút bên trong */
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 26px;
            text-align: center;
            line-height: 26px;
            font-size: 12px;
            color: #28a745;
            font-weight: 600;
        }

        input:checked + .slider {
            background-color: #007bff; /* KHÁC TASK */
        }

        input:checked + .slider:before {
            transform: translateX(87px);
            content: "KHÁC TASK";
            color: #007bff;
        }
        
        .toggle-label {
            font-size: 14px;
            color: #666;
            width: 150px;
            text-align: center;
        }

        /* Danh sách Quy tắc (P11-S5) */
        .rules-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rules-table th, .rules-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 14px;
        }

        .rules-table th {
            background-color: #f1f1f1;
            font-weight: 600;
        }

        /* Footer (P11-S6) */
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            border: none;
        }

        .btn-secondary { 
            border: 1px solid #6c757d;
            background-color: #f8f9fa;
            color: #212529;
        }

        .btn-primary { 
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <button onclick="showModal()" style="padding: 10px 20px; margin-top: 50px;">
        Mở Popup P11-SUB
    </button>

    <div id="linkedTaskModal" class="modal" style="display: none;">
        <div class="modal-content">
            
            <div class="modal-header">
                <h4 id="P11-N1">Cấu hình Quy tắc Liên kết Task theo Vị trí</h4>
                <span class="close" onclick="hideModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
            </div>

            <div class="modal-body">
                
                <div class="rule-creation-group">
                    <p style="font-weight: 600; margin-top: 0;">Task Hiện Tại: <span id="currentTaskName" style="color: #007bff;">Open POS (Task A)</span></p>

                    <div class="rule-selection-row">
                        
                        <label>Vị trí Nguồn (A):</label>
                        <select id="sourcePosition" title="P11-S1">
                            <option value="Leader">Leader</option>
                            <option value="POS">POS</option>
                            <option value="Baker">Baker</option>
                        </select>
                        
                        <label class="toggle-switch">
                            <input type="checkbox" id="ruleToggle" onchange="updateTargetSelect()">
                            <span class="slider"></span>
                        </label>

                        <label id="targetLabel">Vị trí Mục tiêu (B):</label>
                        <select id="targetSelect" title="P11-S3">
                            </select>
                        
                        <button class="btn btn-primary" onclick="addRule()" style="flex-grow: 0;" id="P11-S4">Thêm</button>
                    </div>

                    <p id="ruleValidationMessage" style="color: red; margin-top: 10px; display: none;"></p>
                </div>

                <p style="font-weight: 600;">Danh sách Quy tắc:</p>
                <div style="max-height: 250px; overflow-y: auto;">
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Vị trí Nguồn</th>
                                <th style="width: 30%;">Quan hệ</th>
                                <th style="width: 35%;">Mục tiêu</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody id="rulesTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()">Hủy</button>
                <button class="btn btn-primary" onclick="confirmRules()" id="P11-S6">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('linkedTaskModal');
        const ruleToggle = document.getElementById('ruleToggle');
        const sourcePosition = document.getElementById('sourcePosition');
        const targetLabel = document.getElementById('targetLabel');
        const targetSelect = document.getElementById('targetSelect');
        const rulesTableBody = document.getElementById('rulesTableBody');
        const ruleValidationMessage = document.getElementById('ruleValidationMessage');

        // Dữ liệu mẫu (Giả định)
        const ALL_POSITIONS = ['Leader', 'POS', 'Baker', 'Cashier', 'Stocker'];
        const ALL_TASKS = [
            { id: 'TASK_OPEN_POS', name: 'Open POS' },
            { id: 'TASK_BREAK', name: 'Break Time' },
            { id: 'TASK_CLEAN', name: 'Clean Floor' },
            { id: 'TASK_STOCK', name: 'Stock Shelves' },
        ];
        const CURRENT_TASK_ID = 'TASK_OPEN_POS';

        let establishedRules = []; // Dữ liệu lưu trữ chính
        
        // Cập nhật Select Mục tiêu dựa trên trạng thái Toggle (P11-S2)
        function updateTargetSelect() {
            const isSubstitute = ruleToggle.checked; // True: KHÁC TASK, False: CÙNG TASK
            targetSelect.innerHTML = '';
            
            if (!isSubstitute) {
                // 1. CÙNG TASK (Song Song): Mục tiêu là VỊ TRÍ
                targetLabel.textContent = "Vị trí Mục tiêu (B):";
                targetSelect.disabled = false;
                
                // Lọc ra Vị trí nguồn (A) khỏi Vị trí Mục tiêu (B)
                const source = sourcePosition.value;
                const availablePositions = ALL_POSITIONS.filter(p => p !== source);

                availablePositions.forEach(position => {
                    const option = document.createElement('option');
                    option.value = position;
                    option.textContent = position;
                    targetSelect.appendChild(option);
                });
            } else {
                // 2. KHÁC TASK (Thay Thế): Mục tiêu là TASK
                targetLabel.textContent = "Task Mục tiêu (X):";
                targetSelect.disabled = false;

                // Lọc ra Task hiện tại khỏi danh sách Task Mục tiêu
                const availableTasks = ALL_TASKS.filter(t => t.id !== CURRENT_TASK_ID);
                
                availableTasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.name;
                    targetSelect.appendChild(option);
                });
            }
        }

        // Cập nhật lại Select Mục tiêu khi Vị trí Nguồn thay đổi
        sourcePosition.onchange = updateTargetSelect;

        // Thêm Quy tắc (P11-S4)
        function addRule() {
            ruleValidationMessage.style.display = 'none';

            const source = sourcePosition.value;
            const targetValue = targetSelect.value;
            const isSubstitute = ruleToggle.checked; // True: KHÁC TASK

            if (!source || !targetValue) {
                ruleValidationMessage.textContent = 'Vui lòng chọn đầy đủ Vị trí/Task Mục tiêu.';
                ruleValidationMessage.style.display = 'block';
                return;
            }

            let newRule = {
                SourcePosition: source,
                RuleType: isSubstitute ? 'SUBSTITUTE' : 'CONCURRENT',
            };

            if (isSubstitute) {
                newRule.TargetTaskID = targetValue;
            } else {
                newRule.TargetPosition = targetValue;
            }
            
            // Kiểm tra trùng lặp: [Vị trí Nguồn] và [Mục tiêu/Loại] không được trùng
            const isDuplicate = establishedRules.some(rule => 
                rule.SourcePosition === newRule.SourcePosition && 
                rule.RuleType === newRule.RuleType && 
                (rule.TargetPosition === newRule.TargetPosition || rule.TargetTaskID === newRule.TargetTaskID)
            );

            if (isDuplicate) {
                 ruleValidationMessage.textContent = 'Quy tắc này đã được thiết lập. Vui lòng chọn tổ hợp khác.';
                 ruleValidationMessage.style.display = 'block';
                 return;
            }

            establishedRules.push(newRule);
            renderRulesTable();
        }

        // Xóa Quy tắc
        function removeRule(index) {
            establishedRules.splice(index, 1);
            renderRulesTable();
        }

        // Hiển thị Danh sách Quy tắc (P11-S5)
        function renderRulesTable() {
            rulesTableBody.innerHTML = '';
            
            establishedRules.forEach((rule, index) => {
                const row = rulesTableBody.insertRow();
                
                let relationText = '';
                let targetText = '';
                
                if (rule.RuleType === 'CONCURRENT') {
                    relationText = 'PHẢI LÀM CÙNG';
                    targetText = rule.TargetPosition;
                } else {
                    relationText = 'ĐƯỢC THAY THẾ BỞI';
                    const task = ALL_TASKS.find(t => t.id === rule.TargetTaskID);
                    targetText = task ? task.name : 'Task không xác định';
                }

                row.insertCell().textContent = rule.SourcePosition;
                row.insertCell().textContent = relationText;
                row.insertCell().textContent = targetText;
                
                const actionCell = row.insertCell();
                actionCell.innerHTML = `<button onclick="removeRule(${index})" style="color: red; background: none; border: none; cursor: pointer;">Xóa</button>`;
                actionCell.style.textAlign = 'center';
            });
        }

        // Xác nhận và lưu (P11-S6)
        function confirmRules() {
            // [LOGIC BACKEND]: Gửi establishedRules về Backend qua API
            alert('✅ Dữ liệu quy tắc liên kết đã được lưu thành công vào P11:\n' + JSON.stringify(establishedRules, null, 2));
            hideModal();
        }

        // Hàm hiển thị Popup
        function showModal() {
            // Khởi tạo trạng thái ban đầu
            updateTargetSelect(); 
            renderRulesTable();
            modal.style.display = 'flex';
        }

        // Hàm ẩn Popup
        function hideModal() {
            modal.style.display = 'none';
        }

        window.onload = showModal;
    </script>
</body>
</html>