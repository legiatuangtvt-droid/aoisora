<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup Chọn Khung giờ (P12-SUB)</title>
    <style>
        /* CSS Chung và Reset cơ bản */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
            padding: 20px;
        }
        
        /* Cấu trúc Modal/Popup */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Header (P12-T1) */
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background-color: #f7f7f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h4 {
            margin: 0;
            font-weight: 600;
        }

        /* Body (P12-A1, P12-A2, P12-A3, P12-A4) */
        .modal-body {
            padding: 20px;
        }

        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-input-group input[type="time"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 120px;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            border: none;
        }

        .btn-add { /* Btn Thêm (P12-A3) */
            background-color: #28a745;
            color: white;
        }

        .timeframe-list { /* Danh sách Khung giờ (P12-A4) */
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .timeframe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .timeframe-item:last-child {
            border-bottom: none;
        }

        .btn-remove {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .validation-message {
            color: red;
            font-weight: 600;
            margin-bottom: 10px;
            display: none;
        }

        /* Footer (P12-T2, P12-T3) */
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        .btn-secondary { /* Hủy (P12-T2) */
            border: 1px solid #6c757d;
            background-color: #f8f9fa;
            color: #212529;
            margin-left: 10px;
        }

        .btn-primary { /* Xác nhận (P12-T3) */
            background-color: #007bff;
            color: white;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <button onclick="showModal()" style="padding: 10px 20px; margin-top: 50px;">
        Mở Popup P12-SUB
    </button>

    <div id="timeframeModal" class="modal" style="display: none;">
        <div class="modal-content">
            
            <div class="modal-header">
                <h4 id="P12-T1">Chọn Khung giờ làm việc (Timeframe)</h4>
                <span class="close" style="font-size: 24px; cursor: pointer;">&times;</span>
            </div>

            <div class="modal-body">
                
                <div class="time-input-group">
                    <input type="time" id="startTimeInput" value="08:00" title="Giờ Bắt đầu (P12-A1)">
                    <span>đến</span>
                    <input type="time" id="endTimeInput" value="12:00" title="Giờ Kết thúc (P12-A2)">
                    <button class="btn btn-add" onclick="addTimeframe()" id="P12-A3">Thêm</button>
                </div>
                
                <p id="timeValidationMessage" class="validation-message">
                    Lỗi: Khung giờ không hợp lệ.
                </p>

                <ul class="timeframe-list" id="timeframeList">
                    </ul>

                <p id="listValidationMessage" class="validation-message" style="margin-top: 15px;">
                    ❗ Vui lòng chọn ít nhất một khung giờ.
                </p>
                
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal()" id="P12-T2">Hủy</button>
                <button class="btn btn-primary" onclick="confirmTimeframes()" id="P12-T3">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('timeframeModal');
        const listContainer = document.getElementById('timeframeList');
        const timeValidationMessage = document.getElementById('timeValidationMessage');
        const listValidationMessage = document.getElementById('listValidationMessage');
        
        let selectedTimeframes = []; // Array of Objects: [{StartTime: "HH:MM", EndTime: "HH:MM"}, ...]

        // Hàm chuyển đổi HH:MM sang phút (để so sánh dễ dàng)
        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Logic Chồng Lấn (P12-V1)
        function checkOverlap(newStart, newEnd) {
            const newStartMin = timeToMinutes(newStart);
            const newEndMin = timeToMinutes(newEnd);

            // 1. Kiểm tra Giờ Bắt đầu < Giờ Kết thúc
            if (newStartMin >= newEndMin) {
                return "Giờ Kết thúc phải sau Giờ Bắt đầu.";
            }

            // 2. Kiểm tra Chồng Lấn với các khung giờ đã tồn tại
            for (const tf of selectedTimeframes) {
                const existingStartMin = timeToMinutes(tf.StartTime);
                const existingEndMin = timeToMinutes(tf.EndTime);

                // Điều kiện CHỒNG LẤN: Start_new < End_existing VÀ Start_existing < End_new
                if (newStartMin < existingEndMin && existingStartMin < newEndMin) {
                    return `Khung giờ bị chồng lấn với khung giờ đã có: ${tf.StartTime} - ${tf.EndTime}.`;
                }
            }
            
            return null; // Không có lỗi
        }

        // Thêm Khung giờ (P12-A3)
        function addTimeframe() {
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;
            timeValidationMessage.style.display = 'none';
            
            if (!startTime || !endTime) return;

            const error = checkOverlap(startTime, endTime);

            if (error) {
                timeValidationMessage.textContent = "❗ " + error;
                timeValidationMessage.style.display = 'block';
                return;
            }

            // Nếu không lỗi, thêm vào Array và sắp xếp
            const newTimeframe = { StartTime: startTime, EndTime: endTime };
            selectedTimeframes.push(newTimeframe);
            
            // Sắp xếp danh sách theo thời gian bắt đầu
            selectedTimeframes.sort((a, b) => timeToMinutes(a.StartTime) - timeToMinutes(b.StartTime));
            
            renderTimeframeList();
            checkListValidation();
        }

        // Xóa Khung giờ
        function removeTimeframe(index) {
            selectedTimeframes.splice(index, 1);
            renderTimeframeList();
            checkListValidation();
        }

        // Render lại danh sách Khung giờ (P12-A4)
        function renderTimeframeList() {
            listContainer.innerHTML = '';
            selectedTimeframes.forEach((tf, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'timeframe-item';
                listItem.innerHTML = `
                    <span>${tf.StartTime} - ${tf.EndTime}</span>
                    <button class="btn-remove" onclick="removeTimeframe(${index})">
                        &times;
                    </button>
                `;
                listContainer.appendChild(listItem);
            });
        }

        // Kiểm tra validation danh sách (P12-A4 phải có ít nhất 1)
        function checkListValidation() {
            if (selectedTimeframes.length === 0) {
                listValidationMessage.style.display = 'block';
            } else {
                listValidationMessage.style.display = 'none';
            }
        }

        // Xác nhận (P12-T3)
        function confirmTimeframes() {
            if (selectedTimeframes.length === 0) {
                checkListValidation();
                return;
            }

            // [LOGIC BACKEND]: Gửi selectedTimeframes về Backend qua API
            alert('✅ Dữ liệu đã được lưu thành công vào P12:\n' + JSON.stringify(selectedTimeframes, null, 2));
            hideModal();
        }

        // Hàm hiển thị Popup
        function showModal() {
            modal.style.display = 'flex';
            checkListValidation();
        }

        // Hàm ẩn Popup (Hủy - P12-T2)
        function hideModal() {
            modal.style.display = 'none';
            timeValidationMessage.style.display = 'none';
            listValidationMessage.style.display = 'none';
        }

        // Sự kiện Đóng Modal
        document.querySelector('.close').onclick = hideModal;
        window.onclick = function(event) {
            if (event.target == modal) {
                hideModal();
            }
        }

        window.onload = showModal;

    </script>
</body>
</html>